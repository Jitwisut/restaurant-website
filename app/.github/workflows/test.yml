name: Backend CI/CD

# 1. ทำงานเมื่อไหร่? -> เมื่อมีการ Push หรือ Pull Request ไปที่ branch main
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    name: Run Bun Tests
    runs-on: ubuntu-latest

    # 2. พระเอกของเรา: สร้าง Database จำลอง (Service)
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password # <--- ตั้งรหัสแม่กุญแจไว้ที่นี่
          POSTGRES_DB: restaurant_test
        ports:
          - 5432:5432
        # รอให้ Database พร้อมใช้งานก่อนเริ่ม Test (Health Check)
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 3. ดึง Code ล่าสุดมา
      - name: Checkout code
        uses: actions/checkout@v4

      # 4. ติดตั้ง Bun
      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 5. ติดตั้ง Dependencies
      - name: Install dependencies
        run: bun install

      # 6. สร้างไฟล์ .env สำหรับค่า Config อื่นๆ
      - name: Create .env file
        run: |
          echo "JWT_SECRET=super-secret-test-key-for-ci" >> .env
          echo "ORIGIN_URL=http://localhost:3000" >> .env
          # ใส่ DATABASE_URL ลงไฟล์ด้วย (เผื่อ Code อ่านจากไฟล์)
          echo "DATABASE_URL=postgres://postgres:password@postgres:5432/restaurant_test" >> .env

      - name: Setup Database
        env:
          DATABASE_URL: "postgres://postgres:password@localhost:5432/restaurant_test"
        run: bun src/__tests__/setup.ts

      # 7. เริ่มรัน Test (ไม้ตาย: ยัดตัวแปรเข้าคำสั่งโดยตรง)
      - name: Run Tests
        env:
          # บังคับใช้ค่านี้แน่นอน 100% ตรงกับ Service ข้างบนเป๊ะๆ
          DATABASE_URL: "postgres://postgres:password@localhost:5432/restaurant_test"
        run: bun test

      # 8. Deploy (จะทำงานเมื่อ Test ผ่านเท่านั้น)
      - name: Deploy to Render
        if: success()
        run: |
          curl -X post ${{secrets.RENDER_DEPLOY_HOOK_URL}}
